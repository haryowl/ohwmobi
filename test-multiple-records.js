const GalileoskyParser = require('./backend/src/services/parser');

// Sample packet data from the log (first part of the large packet)
const samplePacketData = Buffer.from('01f60910e40120e2495a6821020030100000000000000000330000000034000035e740090b41640042680d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010e30120d8495a6821070030100000000000000000330000000034000035e740090b415e0042680d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010e20120ce495a68210b0030100000000000000000330000000034000035e740090b415f0042680d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010e10120c4495a6821140030100000000000000000330000000034000035e740090b415d0042680d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010e00120ba495a6821010030100000000000000000330000000034000035e740090b415e0042680d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010df0120b0495a6821040030100000000000000000330000000034000035e740090b415d00426e0d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010de0120a6495a6821060030100000000000000000330000000034000035e740090b416400426e0d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010dd01209c495a68210c0030100000000000000000330000000034000035e740090b416000426e0d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010dc012092495a6821110030100000000000000000330000000034000035e740090b416000426e0d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010db012088495a6821150030100000000000000000330000000034000035e740090b416300426e0d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010da01207e495a6821010030100000000000000000330000000034000035e740090b415d00426e0d450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010d9012074495a6821090030100000000000000000330000000034000035e740090b41620042780d450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000001059012080445a6821130030100000000000000000330000000034000035e740090b41640042080e450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000001058012076445a6821020030100000000000000000330000000034000035e740090b41610042100e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000105701206c445a6821050030100000000000000000330000000034000035e740090b41620042100e450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000001056012062445a68210d0030100000000000000000330000000034000035e740090b41620042100e450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000001055012058445a6821110030100000000000000000330000000034000035e740090b41630042100e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000105401204e445a6821140030100000000000000000330000000034000035e740090b41610042100e450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000001053012044445a6821000030100000000000000000330000000034000035e740090b41660042100e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000105201203a445a6821030030100000000000000000330000000034000035e740090b416100421b0e450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000001051012030445a6821070030100000000000000000330000000034000035e740090b416500421b0e450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000001050012026445a68210e0030100000000000000000330000000034000035e740090b416100421b0e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000104f01201c445a6821120030100000000000000000330000000034000035e740090b416100421b0e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000104e012012445a6821000030100000000000000000330000000034000035e740090b416500421b0e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000104d012008445a6821050030100000000000000000330000000034000035e740090b416000421b0e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000104c0120fe435a68210a0030100000000000000000330000000034000035e740090b416400421f0e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000104b0120f4435a6821110030100000000000000000330000000034000035e740090b416a00421f0e450f00460000500000510000520000e22b71a0fffe0c00010000000000020000000000104a0120ea435a6821140030100000000000000000330000000034000035e740090b415f00421f0e450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010490120e0435a6821010030100000000000000000330000000034000035e740090b415e00421f0e450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010480120d6435a6821080030100000000000000000330000000034000035e740090b416200421f0e450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010470120cc435a68210b0030100000000000000000330000000034000035e740090b416400421f0e450f00460000500000510000520000e22b71a0fffe0c0001000000000002000000000010460120c2435a68210e0030100000000000000000330000000034000035e740090b416500422d0e450f00460000502b00510000520000e22b71a0fffe0c0001000000000002000000000010450120b8435a6821120030100000000000000000330000000034000035e740090b416600422d0e450f00460000502900510000520000e22b71a0fffe0c0001000000000002000000000010440120ae435a6821000030100000000000000000330000000034000035e740090b416300422d0e450f00460000500000510000520000e22b71a0fffe0c000100000000000200000000006ee2', 'hex');

console.log('Testing multiple records parsing...');
console.log('Sample packet length:', samplePacketData.length);
console.log('Sample packet data:', samplePacketData.toString('hex'));

// Create parser instance
const parser = new GalileoskyParser();

// Test the parsing
async function testParsing() {
    try {
        console.log('\n=== Testing Packet Parsing ===');
        
        // Parse the packet
        const result = await parser.parse(samplePacketData);
        
        console.log('\n=== Parsing Results ===');
        console.log('Header:', `0x${result.header.toString(16)}`);
        console.log('Length:', result.length);
        console.log('Has unsent data:', result.hasUnsentData);
        console.log('Number of records found:', result.records.length);
        
        // Analyze each record
        result.records.forEach((record, index) => {
            console.log(`\n--- Record ${index + 1} ---`);
            console.log('Tags found:', Object.keys(record.tags));
            
            // Check for specific tags
            if (record.tags['0x10']) {
                console.log('Archive Record Number:', record.tags['0x10'].value);
            }
            if (record.tags['0x20']) {
                console.log('DateTime:', record.tags['0x20'].value);
            }
            if (record.tags['0x30']) {
                console.log('Coordinates:', record.tags['0x30'].value);
            }
        });
        
        // Verify we have the expected number of records (should be around 34)
        if (result.records.length > 0) {
            console.log('\n✅ Parsing successful!');
            console.log(`Found ${result.records.length} records`);
        } else {
            console.log('\n❌ No records found - parsing may have failed');
        }
        
    } catch (error) {
        console.error('\n❌ Parsing error:', error.message);
        console.error('Stack trace:', error.stack);
    }
}

// Run the test
testParsing().then(() => {
    console.log('\n=== Test completed ===');
}).catch(error => {
    console.error('Test failed:', error);
}); 